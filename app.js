var express = require('express'),
    app = express(),
    path = require('path'),
    fs = require('fs'),
    config = {
        image: path.join(__dirname, 'assets', 'image.jpg'),
        log: path.join(__dirname, 'log.json'),
        home: path.join(__dirname, 'assets', 'home.html')
    };

app.get('/user', function (req, res) {
    var accept = req.header('accept'),
        referer = req.header('referer'),
        reqLog = {
            IP: req.header('x-forwarded-for') || req.connection.remoteAddress,
            date: new Date(),
            headers: req.headers
        },
        log = require(config.log);
    log.push(reqLog);
    if (/image\/(.*)/.test(accept) && /linkedin.com/.test(referer)) { // :p
        res.sendFile(config.image);
        fs.writeFile(config.log, JSON.stringify(log, null, '   '));
    } else {
        res.sendFile(config.home);
    }
});

app.listen(3000, function () {
    console.log('app listening on port 3000!')
});